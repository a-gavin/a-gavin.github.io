<!doctype html>
<html class="not-ready lg:text-base" lang="en">
  <head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <!-- 'shrint-to-fit=no' is a post-Safari 9.0 workaround
        https://stackoverflow.com/questions/33767533/what-does-the-shrink-to-fit-viewport-meta-attribute-do
    -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />

  <title>Alex Gavin</title>
  <link rel="icon" type="image/x-icon" href="https://a-gavin.github.io/favicon.ico" />

  <!-- Author/description -->
  <meta name="author" content="Alex Gavin" />
  <meta name="description" content="Portfolio website" />

  <!-- CSS & JS -->
  <link rel="preload stylesheet" href="https://a-gavin.github.io/main.css" />
  <link
    href="https://pvinis.github.io/iosevka-webfont/3.4.1/iosevka.css"
    rel="stylesheet preload"
    as="font"
  />
</head>


  <body>
    <!-- Header -->
<header class="sticky top-0 z-40 min-h-[3.5rem] w-full">
  <div class="top-4 mx-auto flex w-full max-w-4xl justify-between bg-white p-4">
    <!-- Left top menu -->
    <div class="flex justify-between">
      <a class="text-xl" href="https:&#x2F;&#x2F;a-gavin.github.io">Alex Gavin</a>
    </div>

    <!-- Right desktop menu -->
    <div class="hidden w-auto items-center sm:flex">
      <div class="flex space-x-6">
        <a
          class="primary-link block text-center text-xl"
          href="https:&#x2F;&#x2F;a-gavin.github.io"
          aria-current="page"
          >About</a
        >
        <a
          class="primary-link block text-center text-xl"
          href="https://alw32c9tw.s3.us-west-2.amazonaws.com/AlexGavinResume.pdf"
          >CV</a
        >
        <a class="primary-link block text-center text-xl" href="https:&#x2F;&#x2F;a-gavin.github.io/blog">Blog</a>
      </div>
    </div>
    <!-- Right mobile menu button -->
    <div class="fixed right-0 top-0 flex items-center p-5 sm:hidden">
      <button
        type="button"
        class="group peer relative z-10 inline-flex items-center justify-center rounded-md text-gray-600 active:text-gray-300 peer-focus:block"
      >
        <!-- Icon when menu is closed.
             Menu open: "hidden", Menu closed: "block" -->
        <svg
          class="block size-6 group-focus:hidden"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          aria-hidden="true"
          data-slot="icon"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"
          />
        </svg>
        <!-- Icon when menu is open.
             Menu open: "block", Menu closed: "hidden" -->
        <svg
          class="hidden size-6 group-focus:block"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          aria-hidden="true"
          data-slot="icon"
        >
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
        </svg>
      </button>

      <!-- Right mobile menu -->
      <div
        class="active-within:block peer hidden focus-within:block focus:block active:block peer-focus:block"
      >
        <div
          class="fixed right-0 top-0 flex flex-row space-x-4 bg-white p-4 text-left ring-1 ring-gray-500"
        >
          <div class="menu flex flex-col space-y-1">
            <ul>
              <li>
                <a class="primary-link inline-flex text-xl" href="https:&#x2F;&#x2F;a-gavin.github.io">About</a>
              </li>
              <li>
                <a
                  class="primary-link inline-flex text-xl"
                  href="https://alw32c9tw.s3.us-west-2.amazonaws.com/AlexGavinResume.pdf"
                  >CV</a
                >
              </li>
              <li>
                <a class="primary-link inline-flex text-xl" href="https:&#x2F;&#x2F;a-gavin.github.io/blog"
                  >Blog</a
                >
              </li>
            </ul>
          </div>
          <div class="width-6 block p-4"></div>
        </div>
      </div>
    </div>
  </div>
</header>


    <!-- Maximum width and padding should match that in header -->
    <main class="prose prose-neutral relative mx-auto max-w-3xl p-4">
      <!---->

<div class="mb-8">
  <div class="flex items-center justify-center text-2xl">
    <p class="text-center">WiFi Packet Capture on Linux</p>
  </div>
  <time class="my-0 flex items-center justify-center opacity-80"
    >10-21-23</time
  >
</div>

<section class="opacity-90"><h2 id="overview">Overview</h2>
<p><strong>NOTE:</strong> This guide assumes you have admin access to the machine you're using.</p>
<p>This guide demonstrates how to configure and use a WiFi radio on a Linux system to perform WiFi packet capture. It assumes you are familiar with general networking concepts, are comfortable in a Linux terminal, and assumes at least a little bit of WiFi knowledge.</p>
<p>Unlike network interfaces like Ethernet, performing packet capture on the existing wireless interface (e.g. <code>wlan0</code>) will not necessarily capture arbitrary WiFi traffic. Different device drivers and firmware operate differently, so you may see some additional traffic. However, to capture WiFi traffic present over the air <em>not destined to your device</em>, one must configure a separate WiFi monitor interface. This guide details how to do so.</p>
<p>If you want more background information on WiFi or would like to watch my talk on the subject, watching <a href="https://www.youtube.com/watch?v=Hi-tt3Cdf0M&amp;list=PLjDc7gDlIAST09nqYxYxpn_VdQPVzyAcs&amp;index=6">the recording</a> may prove useful.</p>
<h2 id="definitions">Definitions</h2>
<p>Since networking and WiFi use so many acronymns and abbreviations (and I will use them in this guide), here's a list of some common terms and what they mean:</p>
<ul>
<li><strong>Radio:</strong> The physical hardware used to communicate over WiFi.</li>
<li><strong>Interface:</strong> A logical abstraction created by an operating system for managing network devices. These can be virtual or physical.</li>
<li><strong>STA (or station):</strong> Any client that connects to an access point (AP).</li>
<li><strong>AP (or access point):</strong> What most people refer to as a 'router'. A device used to connect to a WiFi network.</li>
<li><strong>vSTA (or virtual station):</strong> Same as STA, but primarily used when discussing STA network interfaces on a system.</li>
<li><strong>vAP (or virtual access point):</strong> Same as AP, but primarily used when discussing AP network interfaces on a system.</li>
<li><strong>Monitor:</strong> A network interface used to perform packet capture.</li>
<li><strong>Band:</strong> A large slice of radio frequency (RF) spectrum available for use by WiFi. This includes 2.4GHz and 5GHz bands, as well as 6GHz band in some parts of the world.</li>
<li><strong>Channel:</strong> A pre-defined and regulated slice of a band which a STA and AP can use to transmit data.</li>
</ul>


<div align="center">
  <a href="https:&#x2F;&#x2F;a-gavin.github.io&#x2F;processed_images&#x2F;80211_lan_topology.dc6c1224f0b14768.png">
    <img src="https:&#x2F;&#x2F;a-gavin.github.io&#x2F;processed_images&#x2F;80211_lan_topology.518309b768a26716.png" alt="802.11 LAN Topology"  />
  </a>
  <figcaption>802.11 LAN Topology</figcaption>
</div>
<h2 id="instructions">Instructions</h2>
<h3 id="1-double-check-some-things-before-starting">1. Double-Check Some Things Before Starting</h3>
<h4 id="ensure-that-your-radio-works-for-your-use-case">Ensure that your radio works for your use case</h4>
<p>This can be somewhat challenging. The easiest method is to check the supported channels output <a href="https://a-gavin.github.io/blog/wifi-packet-capture/#7-1-verify-that-the-channel-you-want-to-sniff-is-supported">later in the guide</a>. However, some radios have specific limitations that can be tricky to discover unless you know what to look for. When in doubt, read the kernel source (/s).</p>
<p>For example:</p>
<ul>
<li>An AX210 does 6GHz, but AX200 does not. Both are 802.11ax, but only the AX210 is WiFi 6E (AX200 is WiFi 6)</li>
<li>A MTK7922 can do 160MHz channels, but MTK7921 can only do 80MHz</li>
<li>AX210 and BE200 radios must first detect that they are in a regulatory domain which supports 6GHz in order to use the 6GHz band. There's a bit of a dance to get that done (see <a href="https://a-gavin.github.io/blog/wifi-packet-capture/#6ghz-packet-capture-with-intel-radios">this section</a>)</li>
</ul>
<h4 id="ensure-you-have-a-backup-internet-connection-method">Ensure you have a backup internet connection method</h4>
<p>You can perform packet capture offline. However, creating a monitor mode interface as this guide instructs will effectively disable any use of parent radio for other usage. <strong>I recommend connecting a backup network interface if possible (e.g. Ethernet).</strong></p>
<h4 id="ensure-that-you-have-admin-access-on-machine">Ensure that you have admin access on machine</h4>
<p>The commands used here require <code>sudo</code> access.</p>
<h4 id="ensure-no-other-programs-will-interfere">Ensure no other programs will interfere</h4>
<p><strong>NOTE:</strong> <strong>If you decide to delete the existing interface later on in this guide, this step is not necessary</strong>. This step is only necessary if you intend to keep any managed network interface when doing WiFi packet capture. This is generally possible if you 'DOWN' the managed interface before using the monitor and avoid using it while performing captures.</p>
<p>If you opt to keep the existing wireless interface around, other system programs may get in the way of your packet capture fun. <strong>The likely culprit here is NetworkManager</strong>, which is the de-facto network configuration tool on Linux these days. There's no need to disable NetworkManager entirely. Otherwise, you may lose all network access. Instead we'll configure NetworkManager to ignore the wireless interface (and by extension the wireless radio) we're going to use.</p>
<p>To do so, first determine if NetworkManager is active. Next, determine if any wireless interfaces exist that use the radio you want to use for packet capture (see <a href="https://a-gavin.github.io/blog/wifi-packet-capture/#3-determine-radio-s-phy-name">these</a> <a href="https://a-gavin.github.io/blog/wifi-packet-capture/#4-1-find-all-interfaces-using-radio">sections</a>). Finally, instruct NetworkManager to ignore the interface. The following demonstrates this process for an interface <code>wlan0</code>:</p>
<pre data-lang="Bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#65737e;"># Check if NetworkManager is running (it is with PID 1072)
</span><span style="color:#bf616a;">$</span><span> pgrep NetworkManager
</span><span style="color:#bf616a;">1072
</span><span>
</span><span style="color:#65737e;"># Show devices visible to NetworkManager (note &#39;wlan0&#39;)
</span><span style="color:#65737e;"># Shorthand is `nmcli d`
</span><span style="color:#bf616a;">$</span><span> nmcli device show
</span><span style="color:#bf616a;">DEVICE</span><span>           TYPE      STATE        CONNECTION
</span><span style="color:#bf616a;">wlan0</span><span>            wifi      connected    wlancancan
</span><span style="color:#bf616a;">enp2s0</span><span>           ethernet  unavailable  --
</span><span style="color:#bf616a;">lo</span><span>               loopback  unmanaged    --
</span><span>
</span><span style="color:#65737e;"># Print the wireless device&#39;s properties to verify that it is desired device.
</span><span style="color:#65737e;">#
</span><span style="color:#65737e;"># Here, I know my SSID is &#39;wlancancan&#39; and NetworkManager names WiFi
</span><span style="color:#65737e;"># connections by their SSID by default. Thus, the &#39;GENERAL.CONNECTION&#39; field
</span><span style="color:#65737e;"># matching &#39;wlancancan&#39; tells me this is the right device.
</span><span style="color:#bf616a;">$</span><span> nmcli device show wlan0
</span><span style="color:#bf616a;">GENERAL.DEVICE:</span><span>                         wlan0
</span><span style="color:#bf616a;">GENERAL.TYPE:</span><span>                           wifi
</span><span style="color:#bf616a;">GENERAL.HWADDR:</span><span>                         xx:xx:xx:xx:xx:xx
</span><span style="color:#bf616a;">GENERAL.MTU:</span><span>                            1500
</span><span style="color:#bf616a;">GENERAL.STATE:</span><span>                          100 (connected)
</span><span style="color:#bf616a;">GENERAL.CONNECTION:</span><span>                     wlancancan
</span><span style="color:#bf616a;">GENERAL.CON-PATH:</span><span>                       /org/freedesktop/NetworkManager/ActiveConnection/1
</span><span style="color:#bf616a;">IP4.ADDRESS[1]:</span><span>                         x.x.x.x/x
</span><span style="color:#bf616a;">IP4.GATEWAY:</span><span>                            x.x.x.x
</span><span style="color:#bf616a;">ip4.roUTE[1]:</span><span>                           dst = x.x.x.x/x, nh = 0.0.0.0, mt = 600
</span><span style="color:#bf616a;">IP4.ROUTE[2]:</span><span>                           dst = 169.254.0.0/16, nh = 0.0.0.0, mt = 1000
</span><span style="color:#bf616a;">IP4.ROUTE[3]:</span><span>                           dst = 0.0.0.0/0, nh = x.x.x.x, mt = 600
</span><span style="color:#bf616a;">IP4.DNS[1]:</span><span>                             8.8.8.8
</span><span style="color:#bf616a;">IP6.ADDRESS[1]:</span><span>                         fe80::8fad:12b9:d5a8:e60b/64
</span><span style="color:#bf616a;">IP6.GATEWAY:</span><span>                            --
</span><span style="color:#bf616a;">IP6.ROUTE[1]:</span><span>                           dst = fe80::/64, nh = ::, mt = 1024
</span><span>
</span><span style="color:#65737e;"># Tell NetworkManager to stop managing the WiFi device we want to use
</span><span style="color:#bf616a;">$</span><span> nmcli device set wlan0 managed false
</span></code></pre>
<p>If you’d like NetworkManager to explicitly ignore specific network interfaces or ignore network interfaces whose name matches a specific pattern, see <a href="https://stackoverflow.com/questions/5321380/disable-network-manager-for-a-particular-interface">this guide</a>.</p>
<h3 id="2-install-required-packages">2. Install Required Packages</h3>
<p>In this guide, we'll use <code>iw</code> to configure the wireless monitor interface and Wireshark to perform and analyze packet captures. These are generally not installed by default on most Linux distros, though, so install them as follows:</p>
<pre data-lang="Bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#65737e;"># Debian/Ubuntu:
</span><span style="color:#bf616a;">sudo</span><span> apt install</span><span style="color:#bf616a;"> -y</span><span> iw wireshark
</span><span>
</span><span style="color:#65737e;"># Fedora/RHEL:
</span><span style="color:#bf616a;">sudo</span><span> yum install</span><span style="color:#bf616a;"> -y</span><span> iw wireshark
</span></code></pre>
<h3 id="3-determine-radio-s-phy-name">3. Determine Radio’s PHY Name</h3>
<h4 id="3-1-determine-pci-bus-of-radio">3.1 Determine PCI bus of radio</h4>
<pre data-lang="Bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#65737e;"># Here the PCI bus is &#39;03:00.0&#39;
</span><span style="color:#65737e;">#
</span><span style="color:#65737e;"># May need to remove the pipe to grep and manually read output.
</span><span style="color:#65737e;"># Not all radios will appear w/ &quot;Network controller&quot; prefix.
</span><span style="color:#bf616a;">$</span><span> lspci | </span><span style="color:#bf616a;">grep</span><span> Network
</span><span style="color:#bf616a;">03:00.0</span><span> Network controller: MEDIATEK Corp. MT7921 802.11ax PCI Express Wireless Network Adapter
</span></code></pre>
<h4 id="3-2-determine-phy-name-of-radio">3.2 Determine PHY name of radio</h4>
<p><strong>NOTE:</strong> You can use the <a href="https://github.com/a-gavin/talks/blob/main/lfnw_2023_wifi_pcap/list_interfaces.py"><code>list_interfaces.py</code></a> script to both determine the radio PHY name/number and all interfaces created using that radio. With this information in hand, you can then skip to the <a href="https://a-gavin.github.io/blog/wifi-packet-capture/#4-2-manage-existing-interfaces-using-radio">Manage existing interfaces using radio</a> section.</p>
<p>Find the <code>phyX</code> which matches the PCI bus found in the previous step:</p>
<pre data-lang="Bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#65737e;"># Here the PHY is &#39;phy0&#39;.
</span><span style="color:#65737e;">#
</span><span style="color:#65737e;"># May need to remove the grep here if no output appears.
</span><span style="color:#65737e;"># It&#39;s possible the uppermost portion of the PCI bus is non-zero.
</span><span style="color:#bf616a;">$</span><span> ls</span><span style="color:#bf616a;"> -d</span><span> /sys/class/ieee80211/*/device/driver/* | </span><span style="color:#bf616a;">grep</span><span> 0000 | </span><span style="color:#bf616a;">sed -E </span><span>&#39;</span><span style="color:#a3be8c;">s|^.*(phy[^/]+)/.*/|\1 |</span><span>&#39;
</span><span style="color:#bf616a;">phy0</span><span> 0000:03:00.0
</span></code></pre>
<h3 id="4-manage-radio-s-other-interfaces">4. Manage Radio's Other Interfaces</h3>
<p>For context, some radios support virtual interfaces on Linux (i.e. you can create multiple simultaneous WiFi client or virtual AP interfaces). There are some limitations with this, though, namely all interfaces on one radio must operate on the same channel and more advanced WiFi features like OFDMA may not be supported.</p>
<p>Some radios, like many Intel radios (e.g. BE200), do not support virtual interfaces at all on Linux. They only permit a single STA or AP (non-virtual) per radio (limited to 2.4GHz only for APs on AX200, AX210, BE200 radios). These radios (and most others) do support simultaneous monitor and STA coexistence, but this has limitations and is generally not suggested.</p>
<p>With that said, <strong>ensuring that other network interfaces do not interfere</strong> with the packet capture <strong>depends on the radio you’re using</strong>. My personal suggestion is to remove all network interfaces from the radio before creating the monitor, unless required not to (i.e. <a href="https://a-gavin.github.io/blog/wifi-packet-capture/#6ghz-packet-capture-with-intel-radios">6GHz Packet Capture on Intel Radios</a>). This simplifies things if you need debug your configuration later on.</p>
<h4 id="4-1-find-all-interfaces-using-radio">4.1 Find all interfaces using radio</h4>
<pre data-lang="Bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#65737e;"># Use sysfs directory structure to get interfaces
</span><span style="color:#65737e;"># Example path: `/sys/class/ieee80211/phy0/device/net/wlan0`
</span><span style="color:#65737e;">#
</span><span style="color:#65737e;"># Taken from this StackExchange answer: https://unix.stackexchange.com/a/552995
</span><span style="color:#bf616a;">$</span><span> ls /sys/class/ieee80211/*/device/net/*</span><span style="color:#bf616a;"> -d </span><span>| </span><span style="color:#bf616a;">sed -E </span><span>&#39;</span><span style="color:#a3be8c;">s|^.*(phy[^/]+)/.*/|\1 |</span><span>&#39;
</span><span style="color:#bf616a;">phy0</span><span> wlan0
</span></code></pre>
<h4 id="4-2-manage-existing-interfaces-using-radio">4.2 Manage existing interfaces using radio</h4>
<p>The step depends on whether you plan to delete any existing interfaces or not. You're likely to only have one interface which uses the radio on your system, but if you find more, repeat your chosen step for each interface using the radio.</p>
<p><strong>Choose one:</strong></p>
<ol>
<li>
<p>You want the monitor to be the only network interface using the radio.</p>
<p>You only need to delete the existing interface. You will need to recreate it later if you want to reconnect to the internet
using WiFi (see <a href="https://a-gavin.github.io/blog/wifi-packet-capture/#resetting-your-wifi">this</a> section).</p>
</li>
</ol>
<pre data-lang="Bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#65737e;"># Deletes the &#39;wlan0&#39; interface from the radio
</span><span style="color:#bf616a;">$</span><span> sudo iw dev wlan0 del
</span></code></pre>
<ol start="2">
<li>
<p>You want to keep the existing network interface which uses the radio (coexist with the monitor interface).</p>
<p>You must first ensure that no other system programs will attempt to use the existing wireless interface (see <a href="https://a-gavin.github.io/blog/wifi-packet-capture/#ensure-no-other-programs-will-interfere">this section</a>).</p>
</li>
</ol>
<pre data-lang="Bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#65737e;"># Down the interface
</span><span style="color:#65737e;"># Shorthand is `ip l s down dev wlan0`
</span><span style="color:#bf616a;">$</span><span> sudo ip link set down dev wlan0
</span></code></pre>
<h3 id="5-create-monitor-interface-on-radio">5. Create Monitor Interface on Radio</h3>
<pre data-lang="Bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#65737e;"># Creates monitor interface &#39;moni0&#39; (initially in &#39;DOWN&#39; state)
</span><span style="color:#bf616a;">sudo</span><span> iw phy0 interface add moni0 type monitor
</span></code></pre>
<h3 id="6-set-monitor-interface-up">6. Set Monitor Interface 'UP'</h3>
<pre data-lang="Bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#65737e;"># Initially created in &#39;DOWN&#39; state (as shown in output below)
</span><span style="color:#65737e;"># &#39;-br&#39; stands for brief and shortens output
</span><span style="color:#bf616a;">$</span><span> ip</span><span style="color:#bf616a;"> -br</span><span> link show dev moni0
</span><span style="color:#bf616a;">moni0</span><span>            DOWN           34:c9:3d:0e:79:64 &lt;BROADCAST,MULTICAST&gt;
</span><span>
</span><span style="color:#65737e;"># Set monitor interface &#39;UP&#39; (no output, 0 return is success)
</span><span style="color:#bf616a;">$</span><span> sudo ip link set up dev moni0
</span><span>
</span><span style="color:#65737e;"># Verify interface is &#39;UP&#39;. Look for &#39;UP&#39; and &#39;LOWER_UP&#39; on right side.
</span><span style="color:#65737e;"># &#39;UNKNOWN&#39; state is expected.
</span><span style="color:#65737e;">#
</span><span style="color:#65737e;"># &#39;UP&#39; indicates interface is running. &#39;LOWER_UP&#39; indicates underlying phy is up.
</span><span style="color:#65737e;"># For example, a non-configured but plugged in Ethernet device
</span><span style="color:#65737e;"># may be &#39;DOWN&#39; but &#39;LOWER_UP&#39;. See netdevice(7).
</span><span style="color:#bf616a;">$</span><span> ip</span><span style="color:#bf616a;"> -br</span><span> link show dev moni0
</span><span style="color:#bf616a;">moni0</span><span>            UNKNOWN        34:c9:3d:0e:79:64 &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;
</span></code></pre>
<h3 id="7-configure-monitor-interface">7. Configure Monitor Interface</h3>
<p><strong>NOTE:</strong> Pay close attention here as this is where it can get tricky if you’re not paying attention. Things like bands and channel widths supported by your radio, regulatory domain, and even buggy behavior/radio firmware limitations can complicate this process.</p>
<h4 id="7-1-verify-that-the-channel-you-want-to-sniff-is-supported">7.1 Verify that the channel you want to sniff is supported</h4>
<pre data-lang="Bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#65737e;"># This command lists channels supported by your radio
</span><span style="color:#65737e;">#
</span><span style="color:#65737e;"># Output below is snipped for sake of example. The radio used
</span><span style="color:#65737e;"># in this example does not support 6GHz band.
</span><span style="color:#65737e;">#
</span><span style="color:#65737e;"># Typically, the bands are as follows (although depends on your radio):
</span><span style="color:#65737e;">#    1: 2.4GHz, 2: 5GHz, 3: 6GHz (if your radio supports 6GHz)
</span><span style="color:#bf616a;">$</span><span> iw phy0 channels
</span><span style="color:#bf616a;">Band</span><span> 1:
</span><span>        </span><span style="color:#bf616a;">*</span><span> 2412 MHz </span><span style="color:#b48ead;">[</span><span>1</span><span style="color:#b48ead;">]
</span><span>          </span><span style="color:#bf616a;">Maximum</span><span> TX power: 22.0 dBm
</span><span>          </span><span style="color:#bf616a;">Channel</span><span> widths: 20MHz HT40+
</span><span>          </span><span style="color:#bf616a;">...
</span><span style="color:#bf616a;">Band</span><span> 2:
</span><span>        </span><span style="color:#bf616a;">*</span><span> 5180 MHz </span><span style="color:#b48ead;">[</span><span>36</span><span style="color:#b48ead;">]
</span><span>          </span><span style="color:#bf616a;">Maximum</span><span> TX power: 22.0 dBm
</span><span>          </span><span style="color:#bf616a;">Channel</span><span> widths: 20MHz HT40+ VHT80 VHT160
</span><span>          </span><span style="color:#bf616a;">...
</span><span>        </span><span style="color:#bf616a;">*</span><span> 5260 MHz </span><span style="color:#b48ead;">[</span><span>52</span><span style="color:#b48ead;">]
</span><span>          </span><span style="color:#bf616a;">Maximum</span><span> TX power: 22.0 dBm
</span><span>          </span><span style="color:#bf616a;">No</span><span> IR
</span><span>          </span><span style="color:#bf616a;">Radar</span><span> detection
</span><span>          </span><span style="color:#bf616a;">Channel</span><span> widths: 20MHz HT40+ VHT80 VHT160
</span><span>          </span><span style="color:#bf616a;">DFS</span><span> state: usable (for 60400 sec)
</span><span>          </span><span style="color:#bf616a;">DFS</span><span> CAC time: 60000 ms
</span><span>          </span><span style="color:#bf616a;">...
</span><span>        </span><span style="color:#bf616a;">*</span><span> 5340 MHz </span><span style="color:#b48ead;">[</span><span>68</span><span style="color:#b48ead;">]</span><span> (disabled)
</span><span>        </span><span style="color:#bf616a;">*</span><span> 5360 MHz </span><span style="color:#b48ead;">[</span><span>72</span><span style="color:#b48ead;">]</span><span> (disabled)
</span><span>        </span><span style="color:#bf616a;">*</span><span> 5380 MHz </span><span style="color:#b48ead;">[</span><span>76</span><span style="color:#b48ead;">]</span><span> (disabled)
</span><span>        </span><span style="color:#bf616a;">*</span><span> 5400 MHz </span><span style="color:#b48ead;">[</span><span>80</span><span style="color:#b48ead;">]</span><span> (disabled)
</span><span>        </span><span style="color:#bf616a;">*</span><span> 5420 MHz </span><span style="color:#b48ead;">[</span><span>84</span><span style="color:#b48ead;">]</span><span> (disabled)
</span><span>        </span><span style="color:#bf616a;">*</span><span> 5440 MHz </span><span style="color:#b48ead;">[</span><span>88</span><span style="color:#b48ead;">]</span><span> (disabled)
</span><span>        </span><span style="color:#bf616a;">*</span><span> 5460 MHz </span><span style="color:#b48ead;">[</span><span>92</span><span style="color:#b48ead;">]</span><span> (disabled)
</span><span>        </span><span style="color:#bf616a;">*</span><span> 5480 MHz </span><span style="color:#b48ead;">[</span><span>96</span><span style="color:#b48ead;">]</span><span> (disabled)
</span><span>          </span><span style="color:#bf616a;">...
</span></code></pre>
<h4 id="7-2-configure-monitor-to-desired-channel">7.2 Configure monitor to desired channel</h4>
<p><strong>NOTE:</strong> This assumes your radio supports the channel you would like to sniff. The <a href="https://a-gavin.github.io/blog/wifi-packet-capture/#7-1-verify-that-the-channel-you-want-to-sniff-is-supported">previous step</a> details how to check. Also, if you do not configure the channel, the monitor will default to the 2.4GHz channel 1 with 20MHz channel width.</p>
<p>The following methods demonstrate how to configure the monitor frequency (channel), each using a different command syntax:</p>
<ol>
<li>
<p>Using channel width (generally easier)</p>
<p>You can translate this syntax directly from the <code>iw phy X channels</code> output.
It's possible to specify 160MHz and 320MHz, but some versions of <code>iw</code> do not support those.</p>
</li>
</ol>
<pre data-lang="Bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#bf616a;">$</span><span> sudo iw dev moni0 set freq 5180 80MHz
</span></code></pre>
<ol start="2">
<li>Using center frequency</li>
</ol>
<pre data-lang="Bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#65737e;"># TODO: Center frequency calculation (different cases for 20,40,80,160,320 vs. 80+80 and possibly 6GHz)
</span><span style="color:#bf616a;">$</span><span> sudo iw dev moni0 set freq 5955 80 5985
</span></code></pre>
<p>If you encounter errors, even after verifying that your radio supports the desired channel, check the kernel message buffer (<code>sudo dmesg</code>).</p>
<p>I find it useful to watch the error output as it happens. To do so, use two terminals. In one, run <code>sudo dmesg -w</code> (<code>-w</code> lets you follow the output, similar to <code>tail -f</code>). In the other, run the <code>iw</code> command you’re using to configure the channel.</p>
<p>The following is an example error output for a radio which does not support 160MHz channels:</p>
<pre data-lang="Bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#bf616a;">$</span><span> sudo iw dev moni0 set freq 5180 160MHz
</span><span style="color:#bf616a;">kernel</span><span> reports: (extension) </span><span style="color:#bf616a;">channel</span><span> is disabled
</span><span style="color:#96b5b4;">command</span><span> failed: Invalid argument (-22)
</span></code></pre>
<h4 id="7-3-verify-monitor-is-on-desired-channel">7.3 Verify monitor is on desired channel</h4>
<pre data-lang="Bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#65737e;"># Assuming command to set channel succeeded (&#39;iw dev moni0 set freq ...&#39;),
</span><span style="color:#65737e;"># you should see desired channel and channel width output here
</span><span style="color:#bf616a;">$</span><span> iw dev moni0 info
</span><span style="color:#bf616a;">Interface</span><span> moni0
</span><span>        </span><span style="color:#bf616a;">ifindex</span><span> 17
</span><span>        </span><span style="color:#bf616a;">wdev</span><span> 0x2
</span><span>        </span><span style="color:#bf616a;">addr</span><span> 00:0a:52:06:3c:b4
</span><span>        </span><span style="color:#96b5b4;">type</span><span> monitor
</span><span>        </span><span style="color:#bf616a;">wiphy</span><span> 0
</span><span>        </span><span style="color:#bf616a;">channel</span><span> 140 (5700 MHz)</span><span style="color:#bf616a;">,</span><span> width: 80 MHz, center1: 5690 MHz
</span><span>        </span><span style="color:#bf616a;">txpower</span><span> 24.00 dBm
</span></code></pre>
<h3 id="8-run-wireshark-using-monitor">8. Run Wireshark Using Monitor</h3>
<p><strong>NOTE:</strong> Don't forget about your packet capture if it's running. It will eat up your disk space if you let it!</p>
<p>Open Wireshark with admin permissions (e.g. <code>sudo wireshark</code>) and select the created interface ('moni0' in the example below), then press ‘Enter’ to begin packet capture. If you know the interface you want to sniff on, then you can use the <code>-i</code> option, e.g. <code>sudo wireshark -i moni0</code>.</p>
<p>For on-the-fly analysis, editing a live or recently-stopped capture in Wireshark is sufficient. However, for longer running packet captures (or if you really don't wanna redo your capture), save the capture before analyzing or use a non-GUI CLI tool like <code>tshark</code> (generally a separate package to install) instead.</p>
<p>For a more quick-reference WiFi (802.11) Wireshark filter cheatsheet, see <a href="/blog/2023-10-wifi-packet-capture/80211_wireshark_cheatsheet.pdf">this PDF</a>.</p>


<div align="center">
  <a href="https:&#x2F;&#x2F;a-gavin.github.io&#x2F;processed_images&#x2F;wireshark_selecting_interface.5edf0f8a84669297.png">
    <img src="https:&#x2F;&#x2F;a-gavin.github.io&#x2F;processed_images&#x2F;wireshark_selecting_interface.8952428d282af94c.png" alt="Image of selecting wireless interface to perform packet capture on"  />
  </a>
  <figcaption>Selecting Wireless monitor &#x27;moni0&#x27;</figcaption>
</div>


<div align="center">
  <a href="https:&#x2F;&#x2F;a-gavin.github.io&#x2F;processed_images&#x2F;wireshark_pcap_in_progress.485371920f8fe5fe.png">
    <img src="https:&#x2F;&#x2F;a-gavin.github.io&#x2F;processed_images&#x2F;wireshark_pcap_in_progress.bbe31cc887fdb589.png" alt="Image of packet capture in progress using interface &#x27;moni0&#x27;"  />
  </a>
  <figcaption>Packet capture in progress using &#x27;moni0&#x27;</figcaption>
</div>
<h3 id="9-decrypting-wpa-personal-wpa2-personal-wireless-traffic">9. Decrypting WPA-Personal &amp; WPA2-Personal Wireless Traffic</h3>
<p>When attempting to capture network traffic to/from an access point (AP) that uses &quot;open&quot; authentication (i.e. no encryption), no extra configuration is necessary. Everything is plaintext and painfully insecure. Wireshark just decodes the data as you'd expect. However, for APs which use encryption, you need to perform some extra steps.</p>
<p>If you know the password for the AP, it is straightforward to configure Wireshark to decrypt the data. To do so, configure the credential for the AP in Wireshark (e.g. password and SSID) and capture the initial connection between the STA and the AP, specifically the four-way handshake. In the WiFi world, the initial connection is known as 'association'. To verify you have captured the four-way handshake, filter for <code>eapol</code> or <code>eapol.type == 3</code>. You should see something similar to the following (source and destination MAC addresses removed):</p>


<div align="center">
  <a href="https:&#x2F;&#x2F;a-gavin.github.io&#x2F;processed_images&#x2F;wireshark_4way_handshake.1ad4725862f65c15.png">
    <img src="https:&#x2F;&#x2F;a-gavin.github.io&#x2F;processed_images&#x2F;wireshark_4way_handshake.715dbaaf9ec87274.png" alt="Image of Wireshark capture showing a four-way handshake"  />
  </a>
  <figcaption>EAPOL four-way handshake</figcaption>
</div>
<p>For WPA3-Personal, Wireshark can decrypt traffic. However, the process has limitations and is more involved to configure due to the nature of WPA3-Personal authentication (oh darn, it's more secure! /s). The main limitation when decrypting WPA3-Personal is the traffic you can decrypt with one Wireshark-configured key is limited to traffic transmitted between a single STA and AP, and that's assuming you can easily get the key. This limitation contrasts with WPA-Personal and WPA2-Personal where knowing the credentials is enough to decrypt any traffic transmitted to/received from that AP. It is unclear if Wireshark can decrypt OWE (so-called 'Enhanced Open') authentication.</p>
<p>See the <a href="https://wiki.wireshark.org/HowToDecrypt802.11">HowToDecrypt802.11 guide</a> on Wireshark's Wiki for more information.</p>
<h2 id="resetting-your-wifi">Resetting Your WiFi</h2>
<p>Okay you had your fun, now time to use your WiFi again. You can either reboot (most systems simply recreate a default managed interface on reboot) or run the following commands:</p>
<pre data-lang="Bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#65737e;"># Delete monitor interface
</span><span style="color:#65737e;">#
</span><span style="color:#65737e;"># NetworkManager will deal w/ configuring connection to your WiFi
</span><span style="color:#bf616a;">$</span><span> sudo iw dev moni0 del
</span><span>
</span><span style="color:#65737e;"># Recreate virtual interface we previously deleted
</span><span style="color:#65737e;">#
</span><span style="color:#65737e;"># &#39;managed&#39; is type STA
</span><span style="color:#bf616a;">$</span><span> sudo iw phy0 interface add wlan0 type managed
</span><span>
</span><span style="color:#65737e;"># Tell NetworkManager to configure your radio (might do this by default, but just in case)
</span><span style="color:#65737e;">#
</span><span style="color:#65737e;"># This may happen automatically, but good to run just in case
</span><span style="color:#bf616a;">$</span><span> nmcli device set wlan0 managed true
</span></code></pre>
<h2 id="6ghz-packet-capture-with-intel-radios">6GHz Packet Capture with Intel Radios</h2>
<p><strong>NOTE:</strong> I have only tested this with AX210 and BE200 radios operating in a US wireless regulatory domain.</p>
<p><strong>NOTE:</strong> This assumes that you have <a href="https://a-gavin.github.io/blog/wifi-packet-capture/#3-determine-radio-s-phy-name">determined the radio's phy name</a> and know how to <a href="https://a-gavin.github.io/blog/wifi-packet-capture/#4-1-find-all-interfaces-using-radio">find all interfaces using the radio</a>.</p>
<p>The AX210 and BE200 radios are WiFi 6E and WiFi 7 radios, respectively (unlike the AX200 which is WiFi 6). For context, WiFi 6E is the first generation of WiFi which supports the new 6GHz band. While both radios can only operate as an AP in the 2.4GHz band on Linux, both can operate as both a STA and monitor on 2.4GHz, 5GHz, and 6GHz bands. To use a monitor in the 6GHz band, though, you need to follow a couple steps first.</p>
<p>To configure a 6GHz Intel radio monitor, the radio firmware must first detect that it is in the US wireless regulatory domain. Then, after detection, you can create a monitor on the 6GHz channels that the radio supports. To do so, perform the following steps.</p>
<h3 id="1-delete-all-other-interfaces-using-radio">1. Delete All Other Interfaces Using Radio</h3>
<p>Delete all network interfaces using the radio by following the instructions which run <code>iw dev ... del</code> in <a href="https://a-gavin.github.io/blog/wifi-packet-capture/#4-2-manage-existing-interfaces-using-radio">this</a> section.</p>
<h3 id="2-create-and-up-a-station-on-radio">2. Create and Up a Station on Radio</h3>
<pre data-lang="Bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#65737e;"># Create interface &#39;wlan0&#39; on radio (&#39;managed&#39; is type STA)
</span><span style="color:#bf616a;">$</span><span> sudo iw phy0 interface add wlan0 type managed
</span><span>
</span><span style="color:#65737e;"># Admin &#39;UP&#39; the station, so you can use it
</span><span style="color:#65737e;"># &#39;-br&#39; stands for brief and shortens output
</span><span style="color:#bf616a;">$</span><span> sudo ip</span><span style="color:#bf616a;"> -br</span><span> link set dev wlan0 up
</span><span>
</span><span style="color:#65737e;"># OPTIONAL
</span><span style="color:#65737e;"># Show channels permitted for use on radio
</span><span style="color:#bf616a;">$</span><span> iw phy0 channels
</span></code></pre>
<h3 id="3-run-a-scan-on-station">3. Run a Scan on Station</h3>
<pre data-lang="Bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#65737e;"># Admin &#39;UP&#39; the station, so you can use it
</span><span style="color:#bf616a;">$</span><span> sudo iw dev wlan0 scan
</span></code></pre>
<h3 id="4-create-monitor-interface-on-radio">4. Create Monitor Interface on Radio</h3>
<pre data-lang="Bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#65737e;"># Creates monitor interface &#39;moni0&#39; (initially in &#39;DOWN&#39; state)
</span><span style="color:#bf616a;">sudo</span><span> iw phy0 interface add moni0 type monitor
</span><span>
</span><span style="color:#65737e;"># &#39;UP&#39; monitor interface, so you can use it
</span><span style="color:#bf616a;">$</span><span> sudo ip</span><span style="color:#bf616a;"> -br</span><span> link set dev moni0 up
</span></code></pre>
<h3 id="5-down-station">5. Down Station</h3>
<p><strong>NOTE:</strong> Do not delete the STA interface, only 'DOWN' it. You <strong>must</strong> keep it in order to scan 6GHz.</p>
<p>It is critical that this step comes after creating and 'UP'ing the monitor interface. Otherwise, you will be unable to configure the Intel radio monitor for 6GHz channels.</p>
<pre data-lang="Bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#65737e;"># Admin &#39;DOWN&#39; the station. Does not delete it.
</span><span style="color:#65737e;"># &#39;-br&#39; stands for brief and shortens output
</span><span style="color:#bf616a;">$</span><span> sudo ip</span><span style="color:#bf616a;"> -br</span><span> link set dev wlan0 down
</span></code></pre>
<h3 id="6-verify-6ghz-channels-enabled">6. Verify 6GHz Channels Enabled</h3>
<p><strong>NOTE:</strong> You may see output which only list 20MHz supported channel widths. You should be able to configure other channel widths (40MHz, 80MHz, 160MHz). However, it may take some trial and error. Your best bet is to reference the 6GHz supported channels. Primary scanning channels (PSC) have worked well in my experience.</p>
<p>Look for any 6GHz channels in the output of this command (should be at the end). If you see them, then you can configure the monitor on 6GHz channels. If you jumped here from earlier in the guide, jump to the <a href="https://a-gavin.github.io/blog/wifi-packet-capture/#7-configure-monitor-interface">configure monitor interface</a> step and proceed.</p>
<pre data-lang="Bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#65737e;"># Prints out enabled channels on radio
</span><span style="color:#bf616a;">$</span><span> iw phy0 channels
</span></code></pre>
<h2 id="references">References</h2>
<p><strong>NOTE:</strong> The behavior of <code>iwconfig</code> and <code>ifconfig</code> has been superceded by <code>NetworkManager</code> on most Linux systems. Some of the following references use it instead.</p>
<ul>
<li>
<p><a href="https://web.archive.org/web/20231016194521/http://ict.siit.tu.ac.th/help/iw">Using iw to Manage Wireless LAN in Linux</a></p>
</li>
<li>
<p><a href="https://sandilands.info/sgordon/capturing-wifi-in-monitor-mode-with-iw">Capturing Wireless LAN Packets in Monitor Mode with iw</a></p>
</li>
<li>
<p><a href="https://superuser.com/questions/945517/how-to-determine-what-type-of-wifi-networks-are-supported-by-your-driver-on-linu/945540?_gl=1*1jlqle*_ga*OTk2NTU3ODA2LjE2ODAxMjU0NjI.*_ga_S812YQPLT2*MTY5NzQ4NDc2MS41My4wLjE2OTc0ODQ3NjEuMC4wLjA.#945540">SuperUser: Determining WiFi Configuration Supported by Your Hardware/Drivers</a></p>
</li>
</ul>
</section>


    </main>

    <footer class="w-full pt-6">
  <div class="bottom-4 mx-auto max-w-3xl p-4">
    <ul class="flex items-center justify-center text-lg">
      <li>
        <a class="primary-link block px-3 py-0 text-center" href="./index.html">Email</a>
      </li>
      <li>
        <a class="primary-link l block px-3 py-0 text-center" href="https://github.com/a-gavin"
          >Github</a
        >
      </li>
      <li>
        <a
          class="primary-link block px-3 py-0 text-center"
          href="https://www.linkedin.com/in/alex-gavin/"
          >LinkedIn</a
        >
      </li>
    </ul>
  </div>
</footer>

  </body>
</html>
